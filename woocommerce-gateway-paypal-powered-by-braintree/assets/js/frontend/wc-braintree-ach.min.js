(()=>{"use strict";const e=window.wp.escapeHtml,t=window.wp.hooks,n=window.wp.i18n;jQuery((function(a){window.WC_Braintree_ACH_Handler=class{constructor(e){this.args=e||{},this.enabled=e.enabled,this.gatewayId=e.id,this.clientTokenNonce=e.client_token_nonce,this.ajaxUrl=e.ajax_url,this.storeName=e.store_name,this.mustSaveToken=e.must_save_token,this.defaultPlaceOrderText=e.place_order_text,this.savedAccounts=e.saved_accounts,this.paymentMethodsLink=e.payment_methods_link,this.clientToken=null,this.braintreeClient=null,this.usBankAccountInstance=null,this.dataCollectorInstance=null,this.deviceData=null,this.checkoutForm="form.checkout",this.isTokenizing=!1,this.init()}async init(){if(this.enabled)try{if("undefined"==typeof braintree||void 0===braintree.client)throw new Error("Braintree SDK not loaded");if(await this.getClientToken(),!this.clientToken)return void this.logError("Failed to get client token");this.braintreeClient=await braintree.client.create({authorization:this.clientToken}),this.usBankAccountInstance=await braintree.usBankAccount.create({client:this.braintreeClient}),await this.createDataCollector(),this.attachEventHandlers(),this.log("Integration ready.")}catch(e){this.logError("Initialization error:",e)}}async getClientToken(){const e={action:"wc_"+this.gatewayId+"_get_client_token",nonce:this.clientTokenNonce};try{const t=await a.post(this.ajaxUrl,e);if(!t.success||!t.data)throw new Error(t.data?.message||"Failed to get client token");this.clientToken=t.data}catch(e){throw this.logError("Error fetching client token:",e),e}}async createDataCollector(){return new Promise(((e,t)=>{void 0!==braintree.dataCollector?braintree.dataCollector.create({client:this.braintreeClient,kount:!0},((t,n)=>{if(t)return console.warn("ACH: Data collector creation failed:",t),void e(null);this.dataCollectorInstance=n,this.deviceData=n.deviceData,e(n)})):t(new Error("Braintree Data Collector not loaded"))}))}attachEventHandlers(){const e=this;a(this.checkoutForm).on("checkout_place_order_"+this.gatewayId,(function(){return!!e.isUsingSavedToken()||(!!e.hasNewAccountNonce()||!!e.validateFields()&&(e.tokenizeAccount(),!1))})),a(document.body).on("checkout_error",(function(){e.isTokenizing=!1})),a(document).on("click","#wc-braintree-ach-remove-link",(function(t){t.preventDefault(),e.resetForm()})),["#wc-braintree-ach-account-number","#wc-braintree-ach-routing-number",'input[name="wc-braintree-ach-account-type"]',"input[name=billing_first_name]","input[name=billing_last_name]",'#wc-braintree-ach-tokenize-payment-method[type="checkbox"]'].forEach((t=>{a(document).on("change",t,(function(){e.resetNewAccountNonce(),e.maybeUpdateMandateText()}))})),a(document.body).on("change","input.js-wc-braintree-ach-payment-token",(function(){e.toggleAchForm()})),this.toggleAchForm()}buildMandateTextArguments(e){let t=[];const n=this.getNewBankDetails(),r=a("input.js-wc-braintree-ach-payment-token:checked").val();return e.forEach((e=>{switch(e){case"account_holder_name":t.push([n.firstName,n.lastName].join(" "));break;case"account_number":t.push(n.accountNumber);break;case"account_type":t.push(this.getAccountType(n));break;case"authorization_date":t.push((new Date).toISOString().split("T")[0]);break;case"bank_name":r?t.push(this.savedAccounts?.[r]?.bank_name||""):t.push("");break;case"cart_total":const a=document.getElementById("wc-braintree-ach-mandate-cart-total");t.push(a?.innerText||"");break;case"checkout_button_text":t.push(this.getPlaceOrderButtonText());break;case"last4":t.push(this.savedAccounts?.[r]?.last4||"");break;case"payment_methods_link":t.push(this.paymentMethodsLink);break;case"routing_number":t.push(n.routingNumber);break;case"store_name":t.push(this.storeName);break;default:t.push(""),this.log("Unknown placeholder:",e)}})),t}getAccountType(e){const t=a('input[name="wc-braintree-ach-account-type"]:checked').get(0);return t?.labels?.item(0)?.innerText?t.labels.item(0).innerText:e.accountType}willSaveNewAccountToken(){return a('#wc-braintree-ach-tokenize-payment-method[type="checkbox"]').is(":checked")}maybeUpdateMandateText(){let t,r,i;if(a("input.js-wc-braintree-ach-payment-token:checked").val()){var c;t=null!==(c=window?.wc_braintree_ach_mandate_data?.saved_bank_account)&&void 0!==c?c:null}else{const e=this.getNewBankDetails();var o,s;this.areNewBankDetailsComplete(e)&&(t=this.willSaveNewAccountToken()?null!==(o=window?.wc_braintree_ach_mandate_data?.new_saved_account)&&void 0!==o?o:null:null!==(s=window?.wc_braintree_ach_mandate_data?.new_bank_account)&&void 0!==s?s:null)}var l,u;t&&(r=null!==(l=t?.mandate_text)&&void 0!==l?l:null,i=null!==(u=t?.placeholder_map)&&void 0!==u?u:null);let h="";if(r&&i){const t=this.buildMandateTextArguments(i);h='<div class="wc-braintree-ach-mandate-text"><span>'+r.map((a=>(0,e.escapeHTML)((0,n.sprintf)(a,...t)))).join("</span><span>")+"</span></div>"}a("#wc-braintree-ach-container-mandate-text").html(h)}getPlaceOrderButtonText(){const e=a(this.checkoutForm).find('button[type="submit"], input[type="submit"]').first(),n=e.length?e.text():this.defaultPlaceOrderText;return(0,t.applyFilters)("WooCommerce.Braintree.ACH.placeOrderButtonText",n,e.length>0)}getNewBankDetails(){return{firstName:a("input[name=billing_first_name]").val().latinise(),lastName:a("input[name=billing_last_name]").val().latinise(),accountNumber:a("#wc-braintree-ach-account-number").val(),routingNumber:a("#wc-braintree-ach-routing-number").val(),accountType:a('input[name="wc-braintree-ach-account-type"]:checked').val()}}areNewBankDetailsComplete(e){return!Object.values(e).includes("")}isUsingSavedToken(){const e=a("input.js-wc-braintree-ach-payment-token:checked").val();return"string"==typeof e&&""!==e}hasNewAccountNonce(){const e=this.getNewAccountNonce();return e.length>0&&""!==e.val()}getNewAccountNonce(){return a('input[name="wc_braintree_ach_payment_nonce"]')}resetNewAccountNonce(){this.getNewAccountNonce().val("")}validateFields(){if(this.isUsingSavedToken())return!0;if(this.isTokenizing)return!1;const t=this.getNewBankDetails();return!!this.areNewBankDetailsComplete(t)||(this.renderError((0,e.escapeHTML)((0,n.__)("Your bank account and personal details are incomplete. Please fill out all required fields and try again.","woocommerce-gateway-paypal-powered-by-braintree"))),!1)}async tokenizeAccount(){if(!this.isUsingSavedToken()&&!this.hasNewAccountNonce()&&!this.isTokenizing){this.clearFieldErrors();try{const e=this.getNewBankDetails();if(!this.areNewBankDetailsComplete(e))throw new Error((0,n.__)("Your bank account and personal details are incomplete. Please fill out all required fields and try again.","woocommerce-gateway-paypal-powered-by-braintree"));this.isTokenizing=!0;const t={...e,ownershipType:"personal",billingAddress:{streetAddress:a("input[name=billing_address_1]").val(),extendedAddress:a("input[name=billing_address_2]").val(),locality:a("#billing_city").val(),region:a("#billing_state").val(),postalCode:a("input[name=billing_postcode]").val()}},r=await this.usBankAccountInstance.tokenize({bankDetails:t,mandateText:a("#wc-braintree-ach-container-mandate-text").text()});this.getNewAccountNonce().val(r.nonce),a('input[name="wc_braintree_device_data"]').val(this.deviceData),a('input[name="wc_braintree_ach_bankname"]').val(r.details.bankName),this.isTokenizing=!1,a(this.checkoutForm).removeClass("processing").submit()}catch(e){this.isTokenizing=!1;const t=this.getErrorMessage(e);this.renderError(t)}}}resetForm(){this.resetNewAccountNonce(),a("#wc-braintree-ach-routing-number").val(""),a("#wc-braintree-ach-account-number").val(""),a("#wc-braintree-ach-container-account-info").hide(),a("#wc-braintree-ach-container-form").show(),this.maybeUpdateMandateText()}toggleAchForm(){const e=a("#wc-braintree-ach-container-form");this.maybeUpdateMandateText(),this.isUsingSavedToken()?e.hide():e.show()}getErrorMessage(e){let t=(0,n.__)("An error occurred while processing your ACH payment. Please try again.","woocommerce-gateway-paypal-powered-by-braintree");return"US_BANK_ACCOUNT_TOKENIZATION_NETWORK_ERROR"===e?.code?(t=(0,n.__)("The ACH Direct Debit bank account details you entered are invalid.","woocommerce-gateway-paypal-powered-by-braintree"),a("#wc-braintree-ach-routing-number, #wc-braintree-ach-account-number").addClass("wc-braintree-ach-field-error")):e.message&&(t=e.message),t}clearFieldErrors(){a("#wc-braintree-ach-routing-number, #wc-braintree-ach-account-number").removeClass("wc-braintree-ach-field-error")}renderError(e){this.showError(e,this.checkoutForm)}showError(e,t){const n=jQuery(t);jQuery(".woocommerce-error, .woocommerce-message").remove(),n.prepend('<div class="woocommerce-error">'+e+"</div>"),jQuery("html, body").animate({scrollTop:n.offset().top-100},500)}log(...e){console.log("Braintree (ACH):",...e)}logError(...e){console.error("Braintree (ACH):",...e)}},a(document.body).trigger("wc_braintree_ach_handler_loaded")}))})();