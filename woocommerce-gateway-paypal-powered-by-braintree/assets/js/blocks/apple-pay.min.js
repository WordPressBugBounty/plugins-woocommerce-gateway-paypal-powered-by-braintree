(()=>{"use strict";var e={20:(e,t,a)=>{var n=a(609),o=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),i=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,a){var n,c={},p=null,l=null;for(n in void 0!==a&&(p=""+a),void 0!==t.key&&(p=""+t.key),void 0!==t.ref&&(l=t.ref),t)r.call(t,n)&&!s.hasOwnProperty(n)&&(c[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===c[n]&&(c[n]=t[n]);return{$$typeof:o,type:e,key:p,ref:l,props:c,_owner:i.current}}},848:(e,t,a)=>{e.exports=a(20)},609:e=>{e.exports=window.React}},t={};const a=window.wc.wcBlocksRegistry,n=window.wp.data,o="braintree_credit_card",r=window.wc.wcSettings,i=()=>{const e=(0,r.getSetting)(`${o}_data`,{});return{applePayEnabled:e.apple_pay_enabled,buttonStyle:e.apple_pay_button_style,displayLocations:e.apple_pay_display_locations,merchantName:e.store_name,clientTokenNonce:e.client_token_nonce,isTestEnvironment:e.is_test_environment,supports:e.supports,tokenizationForced:e.tokenization_forced,cartContainsSubscription:e.cart_contains_subscription,ajaxUrl:e.ajax_url,recalculateTotalsNonce:e.apple_pay_recalculate_totals_nonce}},s=()=>window.ApplePaySession&&ApplePaySession.canMakePayments(),c=e=>e?{first_name:e.givenName||"",last_name:e.familyName||"",company:"",address_1:e.addressLines?.[0]||"",address_2:e.addressLines?.[1]||"",city:e.locality||"",state:e.administrativeArea||"",postcode:e.postalCode||"",country:e.countryCode||"",email:e.emailAddress||"",phone:e.phoneNumber||""}:{},p=e=>((e||0)/100).toFixed(2),l=window.wp.element,d=window.wp.i18n;var y=function a(n){var o=t[n];if(void 0!==o)return o.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,a),r.exports}(848);const m=({billing:e,shippingData:t,onClick:a,onClose:n,onSubmit:r,eventRegistration:m,components:u={}})=>{const{LoadingMask:h}=u,[w,_]=(0,l.useState)(!0),[g,b]=(0,l.useState)(null),[f,S]=(0,l.useState)(null),[P,v]=(0,l.useState)(null),[k,C]=(0,l.useState)(null),[x,A]=(0,l.useState)(null),R=(0,l.useRef)(null),E=(0,l.useRef)(null),N=(0,l.useRef)(null),T=(0,l.useRef)(null),j=(0,l.useRef)(null),{applePayEnabled:L,buttonStyle:F,merchantName:M,clientTokenNonce:O,tokenizationForced:z,cartContainsSubscription:I,ajaxUrl:U,recalculateTotalsNonce:D}=i();(0,l.useEffect)((()=>{L&&s()?window.braintree&&window.braintree.client&&window.braintree.applePay?$():(console.error("Braintree SDK not loaded"),b((0,d.__)("Payment scripts not loaded. Please refresh the page.","woocommerce-gateway-paypal-powered-by-braintree")),_(!1)):_(!1)}),[L]);const $=(0,l.useCallback)((async()=>{try{const e=await((e,t,a)=>{const n=new FormData;return n.append("action",`wc_${t}_get_client_token`),n.append("nonce",a),fetch(e,{method:"POST",body:n}).then((e=>e.json())).then((e=>{if(e&&!e.success){const t=e.data&&e.data.message||"";throw new Error(`Could not retrieve the client token via AJAX: ${t}`)}if(e&&e.success&&e.data)return e.data}))})(U,o,O),t=await window.braintree.client.create({authorization:e});R.current=t;const a=await window.braintree.applePay.create({client:t});S(a),_(!1)}catch(e){console.error("Failed to initialize Braintree:",e),b((0,d.__)("Failed to initialize payment method","woocommerce-gateway-paypal-powered-by-braintree")),_(!1)}}),[U,O]),B=(0,l.useCallback)((async(e={})=>{const t=new FormData;t.append("action",`wc_${o}_apple_pay_recalculate_totals`),t.append("nonce",D),e.contact&&(t.append("contact[administrativeArea]",e.contact.administrativeArea||""),t.append("contact[countryCode]",e.contact.countryCode||""),t.append("contact[locality]",e.contact.locality||""),t.append("contact[postalCode]",e.contact.postalCode||"")),e.method&&t.append("method",e.method);try{const e=await fetch(U,{method:"POST",body:t});return await e.json()}catch(e){return{success:!1,data:{message:e.message}}}}),[U,D]),q=(0,l.useCallback)((async()=>{if(f){a();try{const e=J(),a=f.createPaymentRequest(e),o=new ApplePaySession(3,a);o.onvalidatemerchant=async e=>{try{const t=await f.performValidation({validationURL:e.validationURL,displayName:M});o.completeMerchantValidation(t)}catch(e){console.error("Merchant validation failed:",e),o.abort()}},t?.needsShipping&&(o.onshippingcontactselected=async e=>{try{const t=e.shippingContact,a=await B({contact:{administrativeArea:t.administrativeArea||"",countryCode:t.countryCode||"",locality:t.locality||"",postalCode:t.postalCode||""}});if(a.success){const e={};if(a.data.total&&(e.newTotal=a.data.total),a.data.line_items&&(e.newLineItems=a.data.line_items),a.data.shipping_methods&&0===a.data.shipping_methods.length){const t=[new ApplePayError("shippingContactInvalid","country",(0,d.__)("Shipping is not available to this location","woocommerce-gateway-paypal-powered-by-braintree"))];return void o.completeShippingContactSelection({...e,errors:t})}a.data.shipping_methods&&a.data.shipping_methods.length>0&&(e.newShippingMethods=a.data.shipping_methods),o.completeShippingContactSelection(e)}else b((0,d.__)("Something went wrong calculating shipping cost. Please refresh the page and try again.","woocommerce-gateway-paypal-powered-by-braintree")),o.abort()}catch(e){b((0,d.__)("Something went wrong calculating shipping cost. Please refresh the page and try again.","woocommerce-gateway-paypal-powered-by-braintree")),o.abort()}},o.onshippingmethodselected=async e=>{try{const t=await B({method:e.shippingMethod.identifier});if(t.success){const e={};t.data.total&&(e.newTotal=t.data.total),t.data.line_items&&(e.newLineItems=t.data.line_items),o.completeShippingMethodSelection(e)}else b((0,d.__)("Something went wrong calculating shipping cost. Please refresh the page and try again.","woocommerce-gateway-paypal-powered-by-braintree")),o.abort()}catch(e){b((0,d.__)("Something went wrong calculating shipping cost. Please refresh the page and try again.","woocommerce-gateway-paypal-powered-by-braintree")),o.abort()}}),o.onpaymentauthorized=async e=>{try{const t=await f.tokenize({token:e.payment.token});v(t.nonce),C(e.payment.billingContact),A(e.payment.shippingContact),N.current=t.nonce,T.current=e.payment.billingContact,j.current=e.payment.shippingContact,o.completePayment(ApplePaySession.STATUS_SUCCESS),r()}catch(e){console.error("Payment authorization failed:",e),o.completePayment(ApplePaySession.STATUS_FAILURE)}},o.oncancel=()=>{n()},o.begin()}catch(e){console.error("Apple Pay payment failed:",e),b((0,d.__)("Payment failed. Please try again.","woocommerce-gateway-paypal-powered-by-braintree")),n()}}else console.error("Apple Pay instance not initialized")}),[f,a,n,r,M,t,e]);(0,l.useEffect)((()=>{N.current=P,T.current=k,j.current=x}),[P,k,x]),(0,l.useEffect)((()=>{const{onPaymentProcessing:e}=m||{};if(!e)return;const a=e((async()=>{if(!N.current)return{type:"error",message:(0,d.__)("Payment not authorized. Please try again.","woocommerce-gateway-paypal-powered-by-braintree"),messageContext:"wc/checkout/payments"};const e=T.current?c(T.current):{},a=j.current?c(j.current):{};a.email&&!e.email&&(e.email=a.email);const n={wc_braintree_credit_card_payment_nonce:N.current,wc_braintree_apple_pay:"1","wc-braintree_credit_card-new-payment-method":z||I};return T.current&&(n.apple_pay_billing_contact=JSON.stringify(T.current)),j.current&&(n.apple_pay_shipping_contact=JSON.stringify(j.current)),{type:"success",meta:{paymentMethodData:n,billingAddress:e,shippingAddress:t?.needsShipping?a:void 0}}}));return()=>{a()}}),[m?.onPaymentProcessing,z,I,t?.needsShipping]);const J=()=>{const a=p(e?.cartTotal?.value),n=[];(e?.cartTotalItems||[]).forEach((e=>{if(e.value>0)switch(e.key){case"total_items":n.push({type:"final",label:(0,d.__)("Subtotal","woocommerce-gateway-paypal-powered-by-braintree"),amount:p(e.value)});break;case"total_discount":n.push({type:"final",label:(0,d.__)("Discount","woocommerce-gateway-paypal-powered-by-braintree"),amount:"-"+p(e.value)});break;case"total_shipping":n.push({type:"final",label:(0,d.__)("Shipping","woocommerce-gateway-paypal-powered-by-braintree"),amount:p(e.value)});break;case"total_fees":n.push({type:"final",label:(0,d.__)("Fees","woocommerce-gateway-paypal-powered-by-braintree"),amount:p(e.value)});break;case"total_tax":n.push({type:"final",label:(0,d.__)("Taxes","woocommerce-gateway-paypal-powered-by-braintree"),amount:p(e.value)})}}));const o={total:{label:M,amount:a},requiredBillingContactFields:["postalAddress"],requiredShippingContactFields:t?.needsShipping?["postalAddress","email","phone"]:[]};if(n.length>0&&(o.lineItems=n),t?.needsShipping&&t?.shippingRates?.length>0){const e=[];(t.shippingRates[0]?.shipping_rates||[]).forEach((t=>{const a={label:t.name,detail:"",amount:p(parseInt(t.price,10)),identifier:t.rate_id};e.push(a)})),e.length>0&&(o.shippingMethods=e)}return o};if(!L||!s())return null;const V=(0,y.jsx)("button",{className:(()=>{const e=["sv-wc-apple-pay-button"];switch(F){case"white":e.push("apple-pay-button-white");break;case"white-with-line":e.push("apple-pay-button-white-with-line");break;default:e.push("apple-pay-button-black")}return z&&e.push("apple-pay-button-subscription"),e.join(" ")})(),style:{display:"block"},onClick:q,type:"button","aria-label":(0,d.__)("Pay with Apple Pay","woocommerce-gateway-paypal-powered-by-braintree"),disabled:w});return g?(0,y.jsx)("div",{className:"wc-block-components-express-payment__item",children:(0,y.jsx)("div",{className:"wc-block-components-express-payment-apple-pay-error",children:g})}):(0,y.jsx)("div",{className:"wc-block-components-express-payment__item",ref:E,children:(0,y.jsx)(h,{isLoading:w,showSpinner:!0,children:V})})},{applePayEnabled:u,supports:h}=i(),w=({RenderedComponent:e,...t})=>(0,n.select)("core/editor")?null:(0,y.jsx)(e,{...t}),_={name:"braintree_credit_card_apple_pay",paymentMethodId:o,canMakePayment:()=>u&&s(),content:(0,y.jsx)(w,{RenderedComponent:m}),edit:(0,y.jsx)(w,{RenderedComponent:m}),supports:{features:h||[]}};(0,a.registerExpressPaymentMethod)(_)})();