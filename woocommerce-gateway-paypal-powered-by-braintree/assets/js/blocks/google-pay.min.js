(()=>{"use strict";var e={20:(e,t,a)=>{var n=a(609),o=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,a){var n,c={},l=null,d=null;for(n in void 0!==a&&(l=""+a),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)r.call(t,n)&&!i.hasOwnProperty(n)&&(c[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===c[n]&&(c[n]=t[n]);return{$$typeof:o,type:e,key:l,ref:d,props:c,_owner:s.current}}},848:(e,t,a)=>{e.exports=a(20)},609:e=>{e.exports=window.React}},t={};const a=window.wc.wcBlocksRegistry,n=window.wp.data,o="braintree_credit_card",r="braintree_credit_card_google_pay",s=window.wc.wcSettings,i=()=>{const e=(0,s.getSetting)(`${o}_data`,{});return{googlePayEnabled:e.google_pay.flags.is_enabled,googlePayAvailable:e.google_pay.flags.is_available,googleMerchantId:e.google_pay.merchant_id,buttonStyle:e.google_pay.button_style,merchantName:e.store_name,clientTokenNonce:e.client_token_nonce,isTestEnvironment:e.is_test_environment,supports:e.supports,tokenizationForced:e.tokenization_forced,cartContainsSubscription:e.cart_contains_subscription,ajaxUrl:e.ajax_url,allowedCardNetworks:e.google_pay.card_types,allowedCountryCodes:e.google_pay.countries,recalculateTotalsNonce:e.google_pay.recalculate_totals_nonce,processPaymentNonce:e.google_pay.process_payment_nonce}},c=window.wp.element,l=window.wp.i18n;var d=function a(n){var o=t[n];if(void 0!==o)return o.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,a),r.exports}(848);const p=({billing:e,shippingData:t,onClick:a,onClose:n,onSubmit:s,eventRegistration:p,components:y={}})=>{const{LoadingMask:m}=y,[g,w]=(0,c.useState)(!0),[u,_]=(0,c.useState)(null),[h,P]=(0,c.useState)(null),[f,b]=(0,c.useState)(null),[S,N]=(0,c.useState)(!1),C=(0,c.useRef)(null),{googlePayEnabled:I,buttonStyle:A,merchantName:E,clientTokenNonce:O,tokenizationForced:T,cartContainsSubscription:R,isTestEnvironment:k,ajaxUrl:v,googleMerchantId:D,allowedCardNetworks:x,allowedCountryCodes:M,recalculateTotalsNonce:j,processPaymentNonce:L}=i();(0,c.useEffect)((()=>{I?window.braintree&&window.braintree.client&&window.braintree.googlePayment?U():(console.error("Braintree SDK not loaded"),_((0,l.__)("Payment scripts not loaded. Please refresh the page.","woocommerce-gateway-paypal-powered-by-braintree")),w(!1)):w(!1)}),[I]);const U=(0,c.useCallback)((async()=>{try{const e=await((e,t,a)=>{const n=new FormData;return n.append("action",`wc_${t}_get_client_token`),n.append("nonce",a),fetch(e,{method:"POST",body:n}).then((e=>e.json())).then((e=>{if(e&&!e.success){const t=e.data&&e.data.message||"";throw new Error(`Could not retrieve the client token via AJAX: ${t}`)}if(e&&e.success&&e.data)return e.data}))})(v,o,O),a=await window.braintree.client.create({authorization:e});C.current=a;const n=await window.braintree.googlePayment.create({client:a,googlePayVersion:2,googleMerchantId:D});P(n);let r={environment:k?"TEST":"PRODUCTION",merchantInfo:{merchantName:E,merchantId:D},paymentDataCallbacks:{onPaymentAuthorized:async e=>await $(e)}};t?.needsShipping&&(r.paymentDataCallbacks.onPaymentDataChanged=e=>G(e));const s=new google.payments.api.PaymentsClient(r);b(s);const i=await s.isReadyToPay({apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:n.createPaymentDataRequest().allowedPaymentMethods,existingPaymentMethodRequired:!0});N(i&&i.result),w(!1)}catch(e){console.error("Failed to initialize Braintree:",e),_((0,l.__)("Failed to initialize payment method","woocommerce-gateway-paypal-powered-by-braintree")),w(!1)}}),[]),z=(0,c.useCallback)((async()=>{if(h){a();try{const e=await F();await f.loadPaymentData(e)}catch(e){"CANCELED"!==e.statusCode&&(console.error("Google Pay payment failed:",e),_((0,l.__)("Payment failed. Please refresh the page and try again.","woocommerce-gateway-paypal-powered-by-braintree")))}finally{n()}}else console.error("Google Pay instance not initialized")}),[h,a,n,s,E,t,e]),F=async()=>{try{const e=await((e,t,a)=>{const n=new FormData;return n.append("action",`wc_${t}_get_transaction_info`),n.append("nonce",a),fetch(e,{method:"POST",body:n}).then((e=>e.json())).then((e=>{if(e&&!e.success){const t=e.data&&e.data.message||"";throw new Error(`Could not retrieve the transaction info via AJAX: ${t}`)}if(e&&e.success&&e.data)return JSON.parse(e.data)}))})(v,r,O),a=Object.assign({},{apiVersion:2,apiVersionMinor:0});return a.transactionInfo=e,a.merchantInfo={merchantId:D,merchantName:E},a.emailRequired=!0,a.callbackIntents=["PAYMENT_AUTHORIZATION"],t?.needsShipping&&(a.callbackIntents=["SHIPPING_ADDRESS","SHIPPING_OPTION","PAYMENT_AUTHORIZATION"],a.shippingAddressRequired=!0,a.shippingAddressParameters={allowedCountryCodes:M},a.shippingOptionRequired=!0),a.allowedPaymentMethods=h.createPaymentDataRequest().allowedPaymentMethods,a.allowedPaymentMethods[0].parameters.billingAddressRequired=!0,a.allowedPaymentMethods[0].parameters.billingAddressParameters={format:"FULL"},a}catch(e){throw console.error("Google Pay payment failed:",e),e}},$=async e=>{try{e.source="google_pay",e.force_tokenization=T;const t=await((e,t,a,n)=>{const o=new FormData;return o.append("action",`wc_${t}_process_payment`),o.append("nonce",a),o.append("paymentData",JSON.stringify(n)),fetch(e,{method:"POST",body:o}).then((e=>e.json())).then((e=>{if(e&&!e.success){const t=e.data&&e.data.message||"";throw new Error(t)}if(e&&e.success&&e.data)return e.data}))})(v,r,L,e);return window.location=t.redirect,{transactionState:"SUCCESS"}}catch(e){return{transactionState:"ERROR",error:{intent:"PAYMENT_AUTHORIZATION",message:e.message||"Payment could not be processed",reason:"PAYMENT_DATA_INVALID"}}}},G=async e=>{try{let t=e.shippingAddress,a=e.shippingOptionData,n="";"SHIPPING_OPTION"==e.callbackTrigger&&(n=a.id);const o=await((e,t,a,n,o)=>{const r=new FormData;return r.append("action",`wc_${t}_recalculate_totals`),r.append("nonce",a),r.append("shippingAddress",n),r.append("shippingMethod",o),fetch(e,{method:"POST",body:r}).then((e=>e.json())).then((e=>{if(e&&!e.success){const t=e.data&&e.data.message||"";throw new Error(`Could not recalculate totals via AJAX: ${t}`)}if(e&&e.success&&e.data)return JSON.parse(e.data)}))})(v,r,j,t,n);return 0==o.newShippingOptionParameters.shippingOptions.length?{reason:"SHIPPING_ADDRESS_UNSERVICEABLE",message:(0,l.__)("Cannot ship to the selected address.","woocommerce-gateway-paypal-powered-by-braintree"),intent:"SHIPPING_ADDRESS"}:o}catch(e){console.error("Google Pay payment failed:",e),_((0,l.__)("Payment failed. Please try again.","woocommerce-gateway-paypal-powered-by-braintree")),n()}},H=()=>{if(S&&f){const e=f.createButton({onClick:e=>z(e),buttonColor:A,buttonSizeMode:"fill"});return(0,c.createElement)("div",{ref:t=>{t&&(t.innerHTML="",t.appendChild(e))}})}return null};return I&&S?u?(0,d.jsx)("div",{className:"wc-block-components-express-payment__item",children:(0,d.jsx)("div",{className:"wc-block-components-express-payment-google-pay-error",children:u})}):(0,d.jsx)("div",{className:"wc-block-components-express-payment__item",children:(0,d.jsx)(m,{isLoading:g,showSpinner:!0,children:(0,d.jsx)(H,{})})}):null},{googlePayEnabled:y,supports:m}=i(),g=({RenderedComponent:e,...t})=>(0,n.select)("core/editor")?null:(0,d.jsx)(e,{...t}),w={name:r,paymentMethodId:o,canMakePayment:()=>y,content:(0,d.jsx)(g,{RenderedComponent:p}),edit:(0,d.jsx)(g,{RenderedComponent:p}),supports:{features:m||[]}};(0,a.registerExpressPaymentMethod)(w)})();